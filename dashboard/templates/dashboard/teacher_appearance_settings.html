{% extends 'dashboard/base.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Theme Preferences</h5>
            </div>
            <div class="card-body">
                <form method="post" id="theme-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Theme Preference</label>

                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="theme"
                                   id="theme-light" value="light"
                                   {% if current_theme == 'light' %}checked{% endif %}>
                            <label class="form-check-label" for="theme-light">
                                Light Mode
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="theme"
                                   id="theme-dark" value="dark"
                                   {% if current_theme == 'dark' %}checked{% endif %}>
                            <label class="form-check-label" for="theme-dark">
                                Dark Mode
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="theme"
                                   id="theme-auto" value="auto"
                                   {% if current_theme == 'auto' %}checked{% endif %}>
                            <label class="form-check-label" for="theme-auto">
                                Auto (System Preference)
                            </label>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveTheme()">
                        <i class="fas fa-save me-2"></i>Save Preferences
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function saveTheme() {
    const selectedTheme = document.querySelector('input[name="theme"]:checked').value;

    // Save to localStorage for immediate effect
    localStorage.setItem('theme', selectedTheme);

    // Apply theme immediately
    if (selectedTheme === 'auto') {
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.setAttribute('data-theme', systemPrefersDark ? 'dark' : 'light');
    } else {
        document.body.setAttribute('data-theme', selectedTheme);
    }

    // âœ… Send to server so it persists across reloads
    fetch("{% url 'dashboard:update_theme' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ theme: selectedTheme })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            alert("Theme preference saved successfully!");
            setTimeout(() => location.reload(), 500);
        } else {
            alert("Error saving theme: " + data.message);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error saving theme preference");
    });
}
</script>
{% endblock %}
